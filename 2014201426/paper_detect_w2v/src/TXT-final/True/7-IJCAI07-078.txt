
in this paper we study a recent formal model for qualitative spatial reasoning with cardinal direction relations. we give an o n1  algorithm to check the consistency of a network of basic cardinal constraints with variables ranging over the set of connected regions homeomorphic to the closed unit disk  which includes a wide variety of irregularshaped regions . to the best of our knowledge  this was an open problem. a previous algorithm for a domain that includes also disconnected regions works in o n1   but  for the problem we consider here  such an algorithm cannot be used. using the new algorithm we also show that the problem of deciding the consistency of a network of disjunctive cardinal constraints with variables ranging over the set of connected regions is np-complete. our main contribution is based on results from the field of combinatorial geometry.
1 introduction
it is widely accepted that spatial reasoning plays an important role in various artificial intelligence applications  such as geographic information systems  giss   robot navigation  computer vision  etc. algebraic approaches formalize spatial reasoning as constraint satisfaction problems  csps   which can be classified depending on the type of relations between variables representing objects of some topological  or euclidean  space. a first broad distinction can be made between quantitative and qualitative formalisms; we are interested here in qualitative calculi for spatial reasoning  cohn and hazarika  1; sharma et al.  1   which allow a machine to represent and reason with spatial objects making abstractions from quantitative  or metric  knowledge. moreover  qualitative spatial models can be classified in directional  frank  1  and topological  renz and nebel  1 ; the present work falls in the former category.
¡¡different directional  or orientational  spatial reasoning formalisms have been studied for different types of objects  regions . our work in based on a formalism  presented in  skiadopoulos and koubarakis  1   for cardinal direction relations between connected and irregular-shaped regions  which can be used to model areas in various interesting applications  goyal  1 . the model we consider is very expressive since it overcomes some of the limitations of point-based  ligozat  1  and box-based  mukerjee and joe  1; balbiani et al.  1  approximation formalisms with cardinal directions  frank  1 . as a practical example  skiadopoulos and koubarakis  1   in a point-based approximation  spain is northeast of portugal  while in a box-based model portugal is contained in spain; most people would agree that none of this representation is accurate  since spain lies partially at the northwest  at the north  at the northeast  at the east and at the southeast of portugal.
¡¡the present work is organized as follows. in section 1 and 1 we briefly introduce some definitions and an algorithm  given in  skiadopoulos and koubarakis  1   which decides the consistency of a network of basic cardinal constraints where variables represent either connected or disconnected regions of the euclidean space r1. in section 1 we exploit some results from combinatorial geometry which are essential for what we accomplish in section 1; that is  the design of a consistency checking algorithm for a network of basic cardinal constraints over connected regions. we prove the correctness of the algorithm  we analyze its complexity and we show that the same problem for disjunctive constraints is np-complete  before concluding.
1 a formal model for cardinal relations
in this section  we shortly revise the main definitions of skiadopoulos and koubarakis's formalism  for qualitative spatial representation and reasoning with cardinal direction relations. the model is based on previous results for cardinal relations  goyal  1; goyal and egenhofer  1 .
¡¡let reg be the set of regions of r1 that are homeomorphic to the closed unit disk; each region is closed  connected and have connected boundaries. the set of all finite unions of regions in reg is denoted by reg ; regions in reg  may be disconnected and have holes.
¡¡let a = a1¡È¡¤¡¤¡¤¡Èak ¡Ê reg   such that each ai ¡Ê reg  and consider the orthogonal axes of the space r1. the symbols ax   resp.  a+x   and ay   resp.  a+y   denote the infimum  resp.  the supremum  of the projection of each region ai on the x-axis and y-axis. the minimum bounding box of region a  denoted mbb a   is the box formed by the straight lines

figure 1: tiles and mbb w.r.t. region b
x = ax   x = a+x   y = ay   y = a+y . any box with area greater than 1 will be called non-trivial box. we will refer to ax  a+x  ay  a+y as the endpoints of mbb a . by considering the axes of mbb b   where b is called the reference region  the space is divided into 1 areas that are represented by the tile-symbols b s sw w nw n ne e se  see figure 1 . tile-areas are closed  unbounded  except for b b    pairwise disjoint  or with a non-trivial box intersection  and their union is r1. an expression like r1:r1:...:rk  where 1   k ¡Ü 1 and such that each ri is a tile-symbol will be called a multitile-symbol  and it denotes the union of the corresponding tile-areas.
¡¡a basic cardinal relation  bc-relation  for short  is a binary relation  denoted by a tile or a multitile-symbol r = r1:¡¤¡¤¡¤:rk  that is defined as:
r	¡Ê reg  1 ¦Á	¦Á ¡È	¡È ¦Á ¡Ä
a formula arb where a b are variables ranging over reg  and r is a bc-relation is a basic cardinal constraint  bcconstraint  for short 1.
¡¡when r is a tile-symbol we have that a r b   a ¡Ê r b   which can be equivalently expressed as a conjunction of binary order constraints between the endpoints of mbb a  and mbb b   that is  as a set of binary constraints of the point algebra  pa   van beek  1 . this fact can be used to define the satisfiability of a bc-constraint  as follows. a bcconstraint ar1:¡¤¡¤¡¤:rk b is satisfiable iff there is an assignment of regions in reg  to the primary variable a  the reference variable b and the component variables of a w.r.t. b  that is   in such a way that the following constraints hold:
  order constraints:;
  union constraint:.
¡¡the set of bc-relations over reg  is denoted by d  and contains  elements. elements in the set 1d  are called cardinal relations  and they can be used to represent indefinite information  since they may be disjunctive.
¡¡an interesting restriction of this model can be obtained by constraining regions variables to range over reg. in this case  the set of bc-relations is denoted by d  and contains only 1 out of the 1 elements of d . for example  there are no regions a b in reg such that ae:w b holds  so e:w /¡Ê d. as in the previous case  1d denotes the set of all cardinal relations over reg.
¡¡in order to solve spatial reasoning tasks with cardinal constraints  one can use a binary constraint network  dechter  1 with a set of variables v representingregions of reg   resp.  reg  and a set of constraints c based on the opportune set of cardinal relations between variables. the main problem is  as usual  determining whether the network is consistent or not. a network n with variables v = {a1 ... an} over reg   resp. reg  is consistent iff there exists a solution given by an n-tuple  ¦Á1 ... ¦Án  ¡Ê  reg  n  resp. regn  such that all cardinal constrains in c are satisfied by the assignment ai = ¦Ái  1 ¡Ü i ¡Ü n. in the next section we deal with the  easiest  case consisting of a network with bc-constraints only.
1 consistency of bc-constraints over reg 
in  skiadopoulos and koubarakis  1  the authors present an ad-hoc algorithm  which will be called here sk-con  for consistency checking of a network of basic cardinal constraints with variables ranging over reg . such an algorithm is quite complicated  and  in our view  it presents at least two important problems: 1  its time complexity is high  i.e  o n1   and 1  it is not guaranteed to work when the domain is restricted to the set reg of connected regions. the algorithm takes as input a network n with a set c of bcconstraints from d   a set v with n variables  ranging over
¡¡¡¡¡¡   and it returns 'consistent' if n is consistent; otherwise it returns 'inconsistent'. let us briefly summarize the idea of the three steps  s1 s1 s1  of the algorithm1.
begin of sk-con

	s1	translation:
¡¡  for each cab ¡Ê c of the form ar1:¡¤¡¤¡¤:rk b  consider the set of component variables  and map  into a set of order constraints between the endpoints of mbb a  mbb b  and mbb abi  for each component variable abi ¡Ê sab. notice that the constraints in oab are logically implied by the spatial configuration expressed by cab;
¡¡  form a point algebra csp  pa-csp  with the set of constraints and the set of variables v o defined as the set of all endpoint variables obtained from the previous step.
s1	order constraint checking:
¡¡  solve the pa-csp with cspan algorithm  van beek  1  and  if possible  obtain a solution ¦Òo for the order constraints  otherwise return 'inconsistent';
¡¡  derive a maximal solution ¦Ìo  by considering  for each pair of variables a b and each  the solution-box ¦Ábi for abi  and extending it in all possible directions until it touch whatever line  from the solution-boxes for the mbbs of variables a and b  is closer to it.  see example 1 .
s1 union constraint checking: check if a solution for the network n can be obtained upon the maximal solution ¦Ìo. this control is performed by using the function globalcheckntb  which decides if the set of union constraints cu derived from the set of bcconstraints c can also be satisfied. if so  the algorithm returns 'consistent'; otherwise it returns 'inconsistent'.
end of sk-con
¡¡it is worth noticing that step s1 introduces new variables in such a way that the pa-csp works actually with o n1  variables. thus  since cspan has quadratic time-complexity  the complexity of step s1 is o n1 . at the same time  the function globalcheckntb takes into consideration each variable a ¡Ê v in turn  and it checks if the sets ¦²ba1 ... ¦²bam of maximal solutions corresponding to each set ponent variables of a w.r.t any reference variable bi ¡Ê v   satisfy or not the following predicate:
non-trivial box  ntb :
for all ¦Ò ¡Ê ¦²ba1 ¡È ¡¤¡¤¡¤ ¡È ¦²bam there exists a tuple  such that mbb ¦Ò ¡É
mbb ¦Ò1  ¡É ¡¤¡¤¡¤ ¡É mbb ¦Òm  is a non-trivial box.
¡¡predicate	ntb	holds	iff	function	checkntb  returns 'true':
function checkntb ¦²ba1 ... ¦²bam 
for every s in ¦²ba1 ¡È ¡¤¡¤¡¤ ¡È ¦²bam do
q = {s};
for every do
;
for everyand every q in q do
 is a non-trivial box then
;
return 'false'
return 'true';
¡¡this function works in o n1  and it is called for each variable a ¡Ê v . hence step 1 of the sk-algorithm is o n1   which gives the overall time complexity of the algorithm.
¡¡satisfiability of ntb for variable a ¡Ê v supposes that there is an assignment a = ¦Á so that for each reference variable bi  with ar1i:¡¤¡¤¡¤:rki b  there is also an assignment  for its component variables such that union constraint from cabi is satisfied  that is   and the order constraints in oabi are also satisfied. globalcheckntb guarantees that such an assignment is posible for any variable and hence  there is an assignment ai = ¦Ái  ¦Ái ¡Ê reg   for each ai ¡Ê v such that order and union constraints in co and cu are satisfied and thereby all bc-constraints are satisfied and the network is consistent.
example 1   skiadopoulos and koubarakis  1   let c be the following set of bc-constraints on region variables a  b and c: {ab:n:eb  ab:s:wc  bswc}. figure 1 shows mmb ¦Á  mmb ¦Â  mmb ¦Ã  found for variables a b and c  respectively. when considering ab:n:eb the maximal solutions for component variables of a is the set ¦²ba = {¦Áb1 ¦Áb1 ¦Áb1} and when considering ab:s:w
{¦Ác1 ¦Ác1 ¦Ác1}.

figure 1: ¦²ba and ¦²ca of example 1
1 cardinal constraints and helly-type theorems
in order to design a consistency algorithm for a network of bc-constraints over reg we will keep the first 1 steps of the algorithm sk-con  while we will substitute the last step with a more efficient method  which  as we will show  is suitable for constraints in d. we will accomplish such a result with the help of helly-type theorems of combinatorial geometry  eckoff  1 .
¡¡helly's theorem  in its original formulation  states that if f = {k1 ... kn} is a family of convex sets in a ddimensional euclidean space ed  and for every choice of  d + 1  of these sets  being  d + 1  ¡Ü n  there exists a point that belongs to all the chosen sets  then there exists a point that belongs to all the sets k1 ... kn  that is . this result gave rise to a whole family of theorems  called helly-type theorems  that present the same logical structure  and include those in which it is shown that the fact that every subfamily of k sets meets a certain property p implies that the whole family meets the same property p. the constant k is called the helly number.
¡¡the key idea is to find out whether our problem  that is  the consistency of bc-constraints over reg  is expressible  at least in part  as the problem of checking whether a family of sets in r1  namely  the family fa = {¦²ba1 ... ¦²bam} of sets of maximal solutions for component variables of a w.r.t any of its reference variables bi  satisfies the predicate ntb  in such a way that a helly-type theorem of number 1 is applicable. if it is so  one can find an o n1  function for deciding if the whole family satisfies the predicate ntb  under the hypothesis that such property can be checked  for any 1-members subfamily  in constant time. the following generalization of helly's theorem turned out to be a very useful result:
helly's topological theorem: let f be a finite family of closed sets in rd such that the intersection of every k members of f is a cell  for k ¡Ü d  and it is nonempty for k = d + 1. then is a cell.
for the case d = 1  the expression  is a cell  means that the intersection is a region homeomorphic to the closed unit disk  that is  it belongs to reg. thus  before using this theorem we need to prove a sufficient condition to assure that the intersection of any two sets of fa belongs to reg.
¡¡a common technique in csp is using composition of relations for constraint propagation in order to decide consistency or just to prune the search space. in  skiadopoulos and koubarakis  1  a composition operation   for cardinal relations is defined  but it turns out to be a weak composition  in the sense that it only guarantees that  if ar1 b and br1 c holds  then ar1   r1 c also holds. an algebraic closure algorithm for a network of binary constraints is essentially a path-consistency algorithm based on a weak composition operator  renz and ligozat  1 . such an algorithm makes the input network a-closed. unfortunately  a bc-constraint network over reg may be a-closed but not consistent1. the following is an example  borrowed from  skiadopoulos and koubarakis  1   of an inconsistent bc-network which is a-closed:
example 1 consider the following set of bcconstraint between the variables a b c  and d: {a b:sw:w:n: ne b  a b:sw:w:e:se c a b:sw:w:e: se d  b b:s:sw:w:e:se c  b s:sw d  d b:w:nw:n:
ne:e c}. this network is a-closed but inconsistent.
¡¡nevertheless  an a-closure procedure can still be useful for us  as we will see now. if the domain for regions is reg and the set of constraints is d  then each set ¦²bai of the family fa obtained in step 1 of the algorithm sk-con is  by construction  a region of reg  see again example 1 . obviously  this is not true if the constraints belong to  d    d .
lemma 1 if a network n with constraints in d is a-closed  then for any variable a and any subset b   fa with |b| = 1  the intersectionis a region of reg.
¡¡proof. if n is a-closed  by definition  there is a solution for any 1 variables  i.e.  one can draw 1 regions satisfying all the constraints   which  in general  does not imply that a solution for any 1 variables can be extended to a solution for 1 variables  this may not be true when using a weak composition . in particular  there is a partial solution for variable a and any other two bi bj. since ¦²bai is a maximal connected region w.r.t the relation ra bi between variable a and variable bi  and similarly for  w.r.t the relation
ra bj  then  must be a region from reg  otherwise we would have that  ra bi   rbi bj  ¡É ra bj =    or  ra bj   rbj bi  ¡É ra bi =    which contradicts the assumption of n being a-closed.	
example 1 consider the set of bc-constraint showed in example 1. the a-closure algorithm detects that such set is inconsistent because  b:n:e   sw  ¡É b:s:w =  . so ab:s:w c is not feasible. figure 1 shows that  is the union of two disconnected regions i1 and i1.
still  we cannot directly apply helly's topological theorem  because we can prove that the intersection of two sets of the family fa is a region from reg but  when considering a third set of the family  the nonempty intersection condition only implies that the intersection of all sets of fa is a region of reg. what we need is that the intersection is a region not only connected but also with a special shape compatible the with binary constraints between primary variable a  and the reference variables b1 ... bm. nevertheless  we can state a helly-type theorem for the family fa and the predicate ntb with helly number 1.
theorem 1 let fa = {¦²ba1 ... ¦²bam} be the family of sets of the maximal solutions for component variables of a w.r.t any of its reference variables bi in an a-closed bc-network n over reg. if for every subfamily b   fa  with |b| = 1  ntb holds for b  then ntb holds for fa.
	proof.	first  notice that  for every subfamily with |b| =
1  we have that  by lemma 1  and when |b| =
1  since predicate ntb guarantees that
helly's topological theorem  we have that. it remains to show that ntb holds for fa. let us proceed by induction.
¡¡suppose that ntb holds for every subfamily bk = of size k  and consider the intersection ik = ¦²a1 ¡É ¡¤¡¤¡¤ ¡É ¦²a . by helly's topological theorem  ik is a connected region and  since ntb holds for b by induction hypothesis  this implies that indeed ik is the maximal partial solution for variable a w.r.t variables b1 ... bk  so that all bc-constraints cabi from the subnetwork n  with variables a b1 ... bk  are satisfied. this is true because ik is the non-disjoint union  since ik is connected  of all tu for which mbb ¦Ò  ¡É
mbb ¦Ò1  ¡É ¡¤¡¤¡¤ ¡É mbb ¦Òm  is a non-trivial box  for every ¦Ò ¡Ê ¦²ba1 ¡È ¡¤¡¤¡¤ ¡È ¦²bak. hence  if we add a new set ¦²bak+1 to bk  forming a subfamily bk+1  then we have that ik ¡É¦²bak+1 is also a connected region from reg  by helly's topological theorem  and it also satisfies predicate ntb  since ik is a maximal partial solution for a w.r.t. variables b1 ... bk  as we said above. otherwise ¦²bak+1 contains a convex subset ¦Ò  which corresponds to a maximal solution-box for some component variable w.r.t bk+1  so that that ¦Ò has not a non-trivial box intersection with some solution-box of other component variable w.r.t variable bp of the subnetwork nk restricted to variables a b1 ... bk. this means that the constraints between 1 variables  namely a  bp and bk+1  are not satisfied. but this is not possible under the assumption that n is a-closed. hence ntb holds for bk+1  and so ntb holds for the family fa  as we wanted to prove. 
1 consistency of bc-constraints over reg
in this section we present an o n1  algorithm for consistency checking of a bc-constraint network over the set of connected regions reg. such a problem  to the best of our knowledge  was still open. a restricted case  solved in  cicerone and felice  1   is the pairwise-consistency problem  that is  deciding if one relation ri j is consistent with rj i  which has the primary and reference variables interchanged. we can solve here the consistency problem of the overall network  not only the pairwise-consistency with two variables. our algorithm will make use of the following subparts:
  an algebraic closure algorithm  ac  for short   which uses the operations of  weak  composition  inverse  and intersection of relations  skiadopoulos and koubarakis  1 ;
  step 1 and 1 of the algorithm sk-con  see section 1 .
  a procedure for the global check of ntb through the function checkntb of sk-con applied to every three sets  as theorem 1 suggests.
¡¡our algorithm  called reg-bcon  takes as input a network n with a set c of bc-constraints from d  and a set v with n variables  ranging over reg   and it returns 'consistent' if n is consistent; otherwise it returns 'inconsistent'. in what follows  we briefly summarize the structure of reg-bcon.
begin of reg-bcon

s1 preprocessing: apply ac to n  and if n is not aclosed return 'inconsistent';
s1	translation:  step 1 of sk-con .
s1 order constraint checking:  step 1 of sk-con . s1 union constraint checking: check if ntb holds for any variable  that is 
for each variable a ¡Ê v do for every tuple  bi bj bk  of variables in v do
if 1checkntb  returns 'false'
¡¡¡¡thenreturn 'inconsistent'; return 'consistent';
end of reg-bcon
clearly  the function 1checkntb has exactly the same structure of function checkntb  of the algorithm skcon   with the only exception that it is called over 1 sets instead of  at most  n sets.
theorem 1 algorithm reg-bcon correctly decides whether a network of bc-constraints over reg is consistent.
proof. the correctness of the algorithm follows from theorem 1 and from the correctness of algorithm sk-con. the latter establishes that the set of bc-constraints is consistent if and only if 1  the set of order constraints co has a maximal solution ¦Ìo; 1  a solution for the network n can be obtained upon the maximal solution ¦Ìo  that is  the union constraints in cu are also satisfied.
¡¡we can now proceed exactly as in the case of sk-con  but for the case of a network of bc-constraints over reg. in fact  if algorithm reg-bcon returns 'inconsistent'  then there is no solution for the network. this may happen either when the network is not a-closed  step 1   or when order constraints are not satisfied  step 1   or when union constraints are not satisfied  step 1 . otherwise  the network is consistent because there is a maximal solution that satisfies order and union constraints by correctness of step 1 and by theorem 1. indeed  for every variable a there is a consistent assignment  which is precisely  since theorem 1 guarantees that is a region from reg for which ntb holds. 
theorem 1 algorithm reg-bcon is o n1 .
proof. step 1 is o n1  due to the time complexity of algorithm ac and the fact that all constraints are basic  see  van beek  1  for similar case . step 1 is o n1  and step 1 is o n1   as we discuss in section 1. but now step 1 is o n1  since 1checkntb works in constant time. hence
reg-bcon is o n1 .	 a deeper analysis would reveal that 1checkntb performs no more than 1 elementary operations of intersection of boxes. so  to be precise  our algorithm is o 1 ¡Á n1   but algorithm sk-con is o 1 ¡Á n1 . the constant k = 1 may be decreased taking into account that any region  is the union of at most 1 line-connected convex sets. by lineconnected we mean that there is a vertical or horizontal line joining two regions. step 1 of the algorithm can be modified so that when it obtains a set of maximal solutions   the solution-boxes of ¦²ba may be joined to form a new set  of at most 1 convex sets. for instance  if ab:n:eb and
  as in figure 1  may be joined into one convex set  since they corresponds to adjacent tiles b n.
this is just a matter of comparing the endpoints of 
  as it is done for the intersection of boxes. thereby  step 1 only has to make 1 ¡Á 1 intersection operations.
¡¡the process of joining adjacent tiles can also be exploited to obtain a solution for any variable a. to do so  function 1checkntb has to be redesigned so that a set data structure is used instead of the queue q  which contains the intersections of non-trivial boxes. this is possible because  as we know by theorem 1  the intersection of partial solutions for any four variables is a region of reg.
¡¡we argue that there is no cubic time-complexity algorithm that solves the same problem. this is due to the non-convex natureof bc-constraints. a solution forthe set of component variables of a w.r.t variable b  i.e.   may be concave  and so  it is not representable as a set of point algebra constraints  unless the region is partitioned in convex components  as it is the case. constraints of example 1 represents a subnetwork of four variables for which ntb predicate is false. a bcnetwork of n variables may have a subnetwork like this  for which there is no way of detecting the inconsistency trough algebraic closure or checking the union constraints for any subnetwork of three variables.
¡¡finally  we focus our attention to the problem of deciding the consistency of a network with  disjunctive  cardinal constraints over reg.
theorem 1 the problem of deciding the consistency of a network n with constraints in 1d and region variables over reg is np-complete.
proof. deciding the consistency of n is in np  since a nondeterministic algorithm first guesses a basic constraint for each disjunctive one appearing in n  obtaining a network n where each constraint belongs to d  and then it applies our polynomial algorithm reg-bcom to check the consistency of n. in order to prove that our problem is np-complete  the reduction of the problem 1sat to the problem of satisfiability of a set of cardinal constraints with variables over reg   shown in  skiadopoulos and koubarakis  1   will suffice  since in such a reduction only regions over reg and constraints in 1d are used.	
1 conclusion and future work
in this paper we have considered a very expressive formal model for spatial reasoning with cardinal relations. we have presented an algorithm for consistency checking of a basic cardinal constraint network over a set of connected regions. such a problem  to the best of our knowledge  was still open. the consistency problem has been previously solved for the case of region variables over the set of finite unions of connected regions in time o n1   but the method cannot be directly applied to the case considered here. we have devised an o n1  algorithm by adapting the existing one for disconnected regions and by exploiting helly's topological theorem  which gives us the key to decide if a solution can be obtained for a set of basic cardinal constraints. moreover  the theorem has also been useful for suggesting how to decrease the time-complexity and for the task of finding a solution of the network.
¡¡for future work  we first point out that the following question remains unanswered so far: given that the consistency problem when considering the set of cardinal constraints is np-complete  as we have proved  is it possible to find a subclass  which includes non-basiccardinalconstraints  such that the consistency problem is still tractable  in fact  a tractable disjunctive subclass has been identified  navarrete and sciavicco  1  for the special case of rectangular cardinal relations  i.e.  those that express relations between rectangles  a type of convex region . it is interesting to know what happen when the domain includes non-convex regions.
¡¡it is worth to observe that the same consistency problem we have considered may be solved with a non-constructive method  i.e.  an algorithm that uses the operations of the algebra. one of the problem of the model is that the underlaying algebra has not some desirable properties for an euclideanexact reasoning with cardinal relations  frank  1 . possible extensions of the model  which express more accurately the exact position between two regions and includes the definition of a relational algebra  would be interesting for some applications.
acknowledgment
this work was supported by the spanish ministry of education and science  mec  and the european regional development fund of the european commission  feder  under project medici  tic1-c1 . special thanks to miguela iniesta and francisco balibrea for their comments about the use of helly's topological theorem.
