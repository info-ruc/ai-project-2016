a cooperative algorithm for determining 
surface orientation from a single view 
robert j. woodham 
artificial intelligence laboratory 
massachusetts institute of technology cambridge  massachusetts  1 
introduction 
this paper addresses the problem of determining local surface orientation from the intensity information contained in a single monocular view. it represents another look at the problem of obtaining shape from shading information. this problem was first formulated by  horn 1  as the solution of first-order non-linear partial differential equations. it was subsequently reformulated by  horn 1  to take advantage of the geometric insight provided by the gradient space approach popularized by  huffman i1l 1  and  mackworth 1 . 
the goal of this work is to understand how the observed intensity variation across surfaces of objects forces conclusions about the local topography of those surfaces. the problem is formulated as a problem in image analysis. this paper adopts the position that it is important to examine ways of squeezing out the last ounce of information from the intensity values recorded in an image before taking recourse to high-level knowledge. 
in order to exploit intensity information  it is vital to understand how intensity values arise in an image. the paper begins by introducing gradient space and reflectance map techniques. having developed these tools  the physical constraints imposed by the light source  object surface and viewer geometry are re-examined to recast the  horn i1  formulation as a cooperative computation which determines local surface orientation by matching points in an image to their corresponding points in gradient space. finally  the method is illustrated using the simple example of a lambertian sphere illuminated by a single distant light source. 
gradient space and the reflectance map 
in order to understand the correspondence between intensity data and local surface orientation  it is necessary to relate the geometry of the image forming process to the photometry of the object being imaged. the problem of determining local surface orientation from intensity can be characterized as a mapping: 
t : i u v  -  lso u v  
which assigns to each image intensity point i u v  a local surface orientation lso u v . in a visual world consisting of opaque smooth objects immersed in a transparent medium  the mapping t is well defined since each image intensity point i u v  arises from a unique object point  which  in turn  defines a unique surface orientation . what is not obvious  however  is whether t can be determined from intensity data alone. the difficulty  of course  is that t is not a local operator. in 
v f s f o n - 1 : 
1 
formulating an algorithm for determining local surface orientation from image intensity. it will be important to keep track of how additional physical constraints are used in the computation. 
now  lso u.v  is a two-valued function of u and v since two parameters are required to specify an arbitrary orientation in space. one might expect surface orientation to be difficult to represent explicitly. gradient space is introduced as the appropriate formalism for reasoning about surface orientation. 
gradient space can be derived in several ways. for present purposes  it will be related directly to surface orientation. if the equation of a smooth surface is given by: 
so that the local  outward  surface normal becomes  p q -l . the quantity  p q  will be called the gradient and gradient space is defined to be the two-dimensional space of alt such points  p q . 
the fraction of light reflected by a surface in a given direction depends upon the optical properties of the object material  the surface micro-structure and the spatial and spectral distribution of the incident light. the important photometric observation underlying this work is the following: no matter how complex the distribution of incident illumination  for most surfaces  the fraction of the incident light reflected in a particular direction depends only on the local light source  object surface and viewer geometry. to make this observation more concrete  one can standardize the local representation of the light source  object surface and viewer geometry and tie this representation down to gradient coordinates p and q. 
a surface photometric function   i e g  is typically defined in terms of the three angles i  e and g illustrated in figure i. these angles are called  respectively  the incident  emergent and phase angle. here  the emergent angle e will be referred to as the view angle. 
figure 1 
if both the viewing direction and the direction of incident illumination are known  then expressions for cos i   cos e  and cos g  can be derived in terms of gradient space coordinates p and q. to simplify matters  consider an image forming system 
woodham 
that performs an orthographic projection. the important simplification inherent in the assumption of an orthographic projection is that the viewing direction  and hence the phase angle g  is constant for all image points  u v . to further simplify the mathematics  one can align the viewing direction with the negative z-axis and assume a scaling in u and v that takes object point  x.y.z  to image point  u v  where u - x and v - y  see figure 1 . under this projection  the use of separate image coordinates  u v  is redundant. henceforth  image coordinates  x y  and object coordinates  x.y  will be referred to interchangeably. with this geometry  object space vector  1 -1  points in the direction of the viewer. that is  the viewer is located at gradient space point  1 . 
point  ps qs  . specifying a single distant point source is not a fundamental restriction on the development. non-point sources can be modeled as the superposition of single point sources. the development does  however  assume equal illumination at all surface points. for non-convex surfaces  the reflectance map does not account for the fact that certain surface points can be shadowed with respect to one or more of the sources nor for the fact that certain surface points can receive additional illumination due to light reflected from other sections of surface  mutual illumination . 
corresponding to the surface point  x y i . then  using standard vector algebra  the expressions for cos i   cos e  and cos g  become: 
	figure 1 	recall that  object space vector  p.q.-l  is an  outward  normal to the surface point  x.y z . that is   p q  is the gradient point 

now  for a given distribution of incident illumination  a given surf ace-viewer geometry and a given object material  the image intensity corresponding to a surface point with gradient  p q  is unique. the intensities recorded at each  p q  is called the reflectance map r p q . reflectance maps can be determined empirically  derived from phenomenotogical models of surface reflectivity or derived from analytic models of surface micro-structure. once determined  however  the reflectance map is independent of the shape of the objects being viewed. it represents explicit knowledge of intensities that can be recorded from objects made of a given material and viewed under a particular light source and viewer geometry. the reflectance map accounts for the physical intensities that can be recorded under varying components of diffuse and specular reflection. it does not  of course  account for the human perception of those intensities   eg. a local specular component can make an 
otherwise  dull  surface appear  glossy   
consider an image whose intensity values i x y  have been normalized to equal the reflectance map values at the corresponding gradients  p q . then  the following equation describes the image forming process: 
i x.y  - r p.q  
this is the basic equation relating image intensity to the geometry of the image forming process. it is one equation in the two unknowns p and q. thus  the problem of determining local surface orientation from intensity becomes the problem of finding the point in gradient space  p q  corresponding to the image intensity point i x y . 
now  the simplest case for incident illumination is that of a single distant point source. choose such a source and place it so that object space vector  ps qs -1 points in the direction of the source. that is  the source is located at gradient space 
vi s i o n - 1 : 
1  
using the above expressions  it is clear that one can transform an arbitrary surface photometric function 1 i e g  into a 
reflectance map r p q . by now  it should be clear how points in gradient space correspond to orientations in object space. however  it is possible to be more explicit about the correspondence between movement in gradient space and changes in local surface orientation. 
using elementary trigonometry  the expression for cos e  can be rewritten as: 
this gives a first useful interpretation that the inclination of the surface with respect to the viewing direction varies monotonicalty with the distance from the origin in gradient space. specifically  the distance from the origin is the tangent of the angle between the surface normal and the view vector. as the gradient  p q  moves away from the origin  the inclination of the surface with respect to the viewer increases. as the gradient  p q  moves toward the origin  the inclination of the surface with respect to the viewer decreases. 
now  the view angle e characterizes one of the two degrees of freedom associated with an arbitrary orientation in space. note that the locus of points in object space having a constant view angle e defines a right circular cone oriented along the viewing direction. the angular position of each gradient  p q  on the circle p1   q1 - tan1 e  defines the direction of steepest descent in image space along this cone. this gives a second useful interpretation that the angular position of a point  p.q  in gradient space corresponds to the direction of steepest descent in image space along the original surface. rotating object space about the view vector induces an equal rotation in gradient space. 
woodham 

re-examining physical constraints 
one can formulate the problem of determining the point in gradient space  p q  corresponding to the image intensity point i x y  analytically as has been done in  horn 1 . this work will not be reviewed here. instead  the formal nature of the computation will be put aside in order to first re-examine its basis in the physical world. 
two constraints of importance can be identified: 
1. a given point on a physical surface has a unique orientation in space. 
1. matter is cohesive. it is separated into objects. the surfaces of objects are generally smooth compared with their distance from the viewer. 
the reader will note that these are essentially the same two constraints  marr and poggio 1  use as a basis for their computation of stereo disparity. as in their paper  the goal is to translate the above two physical constraints into rules for how points in an image can be matched to points in gradient space. 
in their most general form  these rules can be expressed as. 
1. uniqueness: each image point may be assigned to at most one location in gradient space 
1. continuity: surfaces vary smoothly almost everywhere only a small fraction of the area of an image is composed of boundaries that correspond to discontinuities of surface. 
the task ahead is to demonstrate that these rules can be explicitly embedded in a computation. the result is an algorithm which attempts to achieve a global correspondence 
- between image points and points in gradient space via local  interactive constraints. 
it has become fashionable to call such algorithms  cooperative  after similar phemomena in physics. perhaps the reader will be more comfortable if the algorithm is presented as a  relaxation scheme . nonetheless  what is important is to get the flavor of how local constraints can propagate back and forth to globally constrain possible matches between image points and points in gradient space. 
specifying local constraint 
the basic equation 
i x y  = r p q  
is one equation in the two unknowns p and q. with this equation alone  the gradient corresponding to a particular image point is constrained to lie on a one parameter  family of  contour s  in gradient space. the goal is to apply further constraint in order to assign a unique location in gradient space to each image point. 
the essential physical constraint to be exploited is the assumption that  compared to the viewing distance  surfaces vary smoothly almost everywhere. this surface smoothness assumption is translated into monotonicity rules on changes to view angle and changes to direction of steepest descent permitted between  closely spaced  image points. 
v   s f o n - 1 : 
1; 
one can illustrate how physical constraint adds additional constraint to the possible gradient space solutions to the basic equation 1 x y  - r p q . suppose  two  closely spaced  image points  x  y   and  x1 y1  are hypothesized to correspond to object points on the same section of smooth surface. further  suppose that the view angle increases in going from  x  y   to  x1 y1  and that the direction of steepest descent decreases in going from  x .y   to  x1 y1 . let  p1.q1  and  p1 q1  be the gradient locations corresponding to  x  y   and  x1 y1 . 
suppose  further  that the basic equation i x y  - r p q  constrains  p t .q i  and  p1 q1  to lie on the contours c  and c1 respectively as shown in figure 1. 

figure 1 shows  superimposed on the two contours of figure 1  the gradient space circle corresponding to the maximum view angle interpretation of  p1 q1  and the gradient space line corresponding to the minimum direction of steepest descent interpretation of  p1 q1 . since the view angle increases in going from  x  y   to  x1 y1   the contour of permissable  p  q   can be restricted to include only those gradient points on c  lying on or within the circle of the maximum view angle interpretation of  p1 q1 . similarly  since direction of steepest descent decreases in going from  x  y   to  x1 y1   the contour of permissable  p t  q t   can be restricted to include only those gradient points on or above the line of the minimum direction of steepest descent interpretation of  p1 q1 . thus  without any additional constraint on  p1 q1   the assumed monotonicity relations between  x  y   and  x1 y1  have been applied to the topography of the reflectance map to constrain the possible interpretation of  p  q   to include only those points of c  indicated by the solid line of figure 1. 
let  r j  denote the polar representation of the gradient space point  p q . that is: 

generalizing from the above illustration* the following two rules are stated: 
woodham 

be a set of  closely spaced  image points hypothesized to correspond to object points on the same section of smooth surface that are monotonically non-decreasing in view angle. let c1 c1  .cn be the corresponding set of gradient contours determined from the reflectance map. then  each contour cj can be further constrained such that  for each 
 r ж╚ ei cit i - 1 n-l min {r |  r $  c ci-1}   r   max {r |  rj  f ci+1  similarly  if 1--in *$ hypothesized to correspond to a set of object points on the same section of smooth surface that are monotonically non-increasing in view angle  then each contour cj can be further constrained such that  for each  r 1  1 c  i - 1 n-l min {r |  rj    c } s r s max {r |  rj  1 c m   
rule ii: changes in direction of steepest descent 
let 1  n be a set of  closely spaced  image points hypothesized to correspond to object points on the same section of smooth surface that are monotonically non-decreasing in direction of steepest descent. as above  let c  c1   cft be the corresponding set of gradient contours. then  each contour c  can be further constrained such that  for each  r f  1 c  i - 1 .. n-l min {$ i  r f  t cmj s $ s max {# |  rj  А chl  similarly  if li i1 ..jn is hypothesized to correspond to a set of object points on the same section of smooth surface that are monotonically non-increasing in direction of steepest descent  then each contour cj can be further constrained such that  for each  r j  e cj  i - 1 .. n-l min {$ i  ri  1 c m   s $ s max  i |  rj  1 cj. } 
hypothesizing monotonicity relations 
it is now time to turn to the question of how to hypothesize monotonicity relations between selected image points. to begin with  consider the worst possible approach. for some small value of n  one might explore all possible orderings  with respect to both view angle and direction of steepest descent  of selected  closely spaced  image points i| i1.. in. the hope would admissable interpretations  ie. interpretations that included at least one gradient point for each image point . the constraints imposed by each local interpretation would propagate to neighboring sets of selected image points to provide further mutual constraint. again  the hope would be that propagation of local constraint would converge to a correct global interpretation while  incorrect  propagations would  quickly  die out. 
consider a second possible approach. suppose a particular surface interpretation is forced onto the data. such an interpretation would provide a framework to  partially  order selected  closely spaced  image points with respect to changes in both view angle and direction of steepest descent. instead of allowing all possible orderings to compete  this second approach pursues a particular interpretation. again  the hope would be that propagation of local constraint would converge to a single global interpretation that represents a simple distortion of the particular interpretation being forced.  here  simple distortion implies any surface that preserves the assumed monotonicity relations concerning changes to view angle and changes to direction of steepest descent.  
the method actually implemented corresponds to this second approach. the program has a small set of interpretations it is willing to pursue. some are quite rigid  others are quite flexible. in the next section  a specific example is presented. for now  a brief analysis is given to show of how convexity can be used to hypothesize monotonicity relations between  closely spaced  image points. 
by partially differentiating the basic equation i x y  - r p q  with respect to x and y we obtain two equations which can be written as the single matrix equation: 
 subscripts denote partial differentiation . similarly  the two first-order equations dp - pxdx + pydy and dq - qkdx + qydy can be written as the single matrix equation: 
observe that py = qx  for smooth surfaces  the order of differentiation can be interchanged . thus  one can define a matrix h by: 
h is the standard hessian matrix  which captures the notion of surface curvature . the first observation to be made is that smoothness guarantees that h is symmetric. thus  it is reasonable to ask under what conditions is h positive semidefinite  a real symmetric n x n matrix a is positive semidefinite if and only if x'ax   1. for all vectors x in r .  now  h is positive semidefinite if and only if z   f x y  is convex. this result is used to show how convexity adds constraint. suppose z - f x y  is convex. thus  h is positive semidefinite. multiplying the two matrix equations on the left by  non-zero   rp rq  and  non-zero   dx dy  respectively  gives the two inequalities: 

be that only a small fraction of those orderings would have 
	v f s l o n - 1 : 	woohham 
1 

 ix rp + iy rq   1 dp dx +dq dy  1 
this first inequality can be viewed as an additional a priori constraint on the contour in gradient space of possible solutions to the basic equation i x y  - r p q . the tangent vector  rp.rq  to the contour of constant reflectance at any point  p q  hypothesized to be a solution to the basic equation i x y  = r p q  must have a non-negative component in the direction of the tangent vector  ix iy  to the contour of constant intensity at  x y . 
the second inequality can be viewed as an additional constraint on the possible movement  dp dq  in gradient space corresponding to a movement  dx dy  in the image. as above  the vector  dp dq  must have a non-negative component in the direction  dx dy  thus  by choosing  dx.dy  appropriately  it is possible to guarantee either the sign of the change to the view angle or the sign of the change to the direction of steepest descent. 
achieving global constraint 
regardless of what mechanism is used to hypothesize  local  monotonicity relations between points in image space  it is stilt necessary to embed that mechanism in a computation to achieve global constraint. the implementation approach taken here is admittedly ad hoc. the program selects nine points in a simple 1 x 1 square pattern as its basic set of  closely spaced  image points. this pattern serves as the set i| i1 in for applying the local constraint criteria  rules i and ii . first  however  the set i1.i1.. in is passed to the chosen hypothesizing routines to be  partially  ordered with respect to view angle and direction of steepest descent. the reflectance map r p q  is then used to 
- determine the initial contour of possible gradient space locations for each point i . rules i and ii are interatively applied to these contours until no further mutual constraint is provided. 
the above describes the basic application of local constraint to each 1 x 1 template. the selection of successive 1 square patterns is allowed to overlap. thus  each image point i  will eventually belong to nine templates. each time a particular image point i  is further constrained by the application of local constraint to a template of which it is a member  each of its eight other templates is marked for reconsideration. before moving on to a previously unconsidered template local constraint is applied recursively to each marked template  with additional marking added as required  until no marked templates remain to be reconsidered. each time an image point ii is considered  any additional constraint on the gradient space contour of possible solutions to the basic equation 
i x y  - r p q  propagates through this local filtering mechanism to all other image points under consideration. 
the next issue to arise is the question of how to terminate the growth of templates. currently  the program terminates only when some image point under consideration has no admissable gradient space interpretation  in which case the  forced  interpretation is deemed to have failed  or when all boundary points to existing templates have view angle greater than some preassigned value  in which case the surface is deemed to be too oblique for further expansion. clearly  these termination conditions are not adequate for a general surface analysis routine. the question of termination also raises deeper issues. how important are boundaries to surface interpretation  how can a complex surface be segmented into simpler  convex/concave  subsections  how does one handle the inherent indentation/protrusion ambiguity in trying to piece together surfaces  these issues must be dealt with. but  for now  let us consider a specific example in order to illustrate the method in operation. 
an example 
consider the simple example of a  lambertian  sphere illuminated by a single distant light source. the intensity space to gradient space correspondence will be derived analytically and then it will be used as a basis for judging the performance of the computation. 
the first task is to generate a reflectance map. to do this  a reflectivity function must be specified. now  the term lambertian refers to a phenomenological model of a perfect diffuse reflector such that the surface appears equally bright from all viewing directions. for such a surface  the reflectivity depends only on the forshortening effect of the varying angle of incidence. in particular  the reflectance function   i.e.g  is given by: 
  i e g  = cos i  
this reflectivity function is transformed into a reflectance map by simply recalling the expression derived earlier for cos i . the reflectance map is thus given by: 

the second task is to determine the local surface orientation of each image point. in the example  this result is particularly easy to obtain. let the object sphere be centered at the origin and have radius r. thus  the equation of the sphere is: 
x1 + y1 + z1 + r1 
elementary calculus will verify that the vector  x y z  defines an 
 outward  normal at each point  x y z  on the surface. the appropriate gradient is obtained by rewriting this normal as  -x/z -y/z -l . now  for each  x y   there are actually two possible z values to be considered. note  however  that in this example the hemi-sphere actually in view corresponds to negative values of z  recall figure 1 . 
the parameters of the image forming system can be factored out by assuming that the image intensity has been normalized to correspond directly to reflectivity. in this case  the intensity recorded at each image point  x y  is equal to the value of the reflectance map at the corresponding  p q . thus  the equation 

finally  the mechanism by which monotonicity relations were hypothesized for this example must be specified. one additional assumption was used. the algorithm assumes that it knows at least one image point corresponding to an object point oriented directly facing the viewer. now  let such a point define a pseudo-origin in image space. since the view angle is 

vision-1: woohham 
1 

assumed to be zero at the pseudo-origin  the only possible interpretation is that  in a particular direction  the view angle is locally non-decreasing with increasing image distance from the pseudo-origin. in general  one can not hope to assert any local monotoniclty relation on direction of steepest descent based on angular position about the pseudo-origin. if  however  the surface is known to be convex  the direction of steepest descent is  locally  non-decreasing with increasing angular position about the pseudo-origin. for the example  the set of image points |1 ... in was ordered in view angle according to their distance in image space from the pseudo-origin and ordered in direction of steepest descent according to their angular position about the pseudo-origin. applied together  these hypothesis rules are equivalent to the strong assumption that the surface in question is a convex solid of revolution. 
for the example  ps = 1  qs - 1 and r - 1. a 1 x 1 test image was considered. the algorithm was applied to this image using 1 x 1 square templates sampled at an image spacing of 1 points  in both x and y . the pseudo-origin was defined as x - 1 and y = 1. the results are first presented as a pair of figures. figure 1 shows the reflectance map r p q  - cos i  drawn as a series of contours  spaced 1 units apart . superimposed are crosses marking the known gradient points  p q  corresponding to the image points  x y  sampled from the image. all gradient points to the left of the contour r p q  - 1 correspond to surface points oriented more than 1бу away from the direction of incident illumination and hence to the self-shadowed region of the sphere. figure 1 shows the restricted subsection of contour determined for each sampled image point. again  crosses are superimposed to illustrate how well the algorithm has performed. the crosses mark the correct gradient points  determined analytically  while the corresponding subsection of contour marks how well the algorithm has isolated those points. 

discussion 
the ultimate criteria for judging the performance of this method is  of course  to discover whether it can be used to solve interesting problems. for now  however  the discussion is restricted to some simple statistics and some qualitative observations. 


v i s i o n - 1 : 	woodham 
1 


note that these measures refer to total angular freedom. if a choice algorithm is adopted which selects the  correct  answer to be at the midpoint of the angular spread  this choice is guaranteed to be no more than half the angular spread in error. thus  the upper right portion of table 1 can be interpreted as follows: 
on the average  by sampling at an image spacing of 1 points in 
x and y  the algorithm was able to position image points  corresponding to surface points less than 1бу in view angle  to within 1бу of their true orientation in space. the standard deviation of this measure over all such points was 1бу while the worst case point was located to within 1/бу of its true orientation in space. 
the performance of the algorithm depends critically on two factors: the ability to hypothesize monotonicity relations between selected image points and the topography of the reflectance map. the discussion of convexity gives some indication of how one can use a priori assumptions about surface geometry to specify monotonicity relations. in any event  given a particular hypothesis mechanism  the algorithm generates a constrained interpretation consistent with that hypothesis mechanism  or demonstrates that no such consistent interpretation is possible . 
the topography of the reflectance map is determined by two factors: the local photometry of the surface being viewed and the light source  object surface and viewer geometry. in general  one would not expect to have much control over the local photometry of the surfaces being viewed. in principle  however  the user is free to vary the light source and viewer geometry to achieve optimal results with the algorithm. this approach has proven particularly useful in extending these techniques to the problem of inspecting for surface defects in metal castings  where it is feasible to construct inspection stations with independently controllable light sources  woodham i1  . 
it allows one to formulate physical constraints on the object surface as simple geometric constraints on the gradient space contour of possible solutions to the basic image forming equation i x y  = r p q . the beauty of the  cooperative  algorithm is that it provides a simple mechanism for propagating these geometric constraints. 
acknowledgements 
i wish to thank berthold k. p. horn  mark lavin  tomas 
lozano-perez  david marr and patrick winston for help with the ideas presented in this paper. anna r. bruss provided valuable proof-reading assistance. this research was conducted at the artificial intelligence laboratory of the massachusetts institute of technology. support for the laboratory's artificial intelligence research is provided in part by the advanced research projects agency of the department of defence under office of naval research contract number n1-1-c-1. 
