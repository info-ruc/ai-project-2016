 
     this paper presents a stereo algorithm using dynamic programming technique. the stereo matching problem  that is  obtaining a correspondence between right and left images  can be cast as a search problem. when a pair of stereo images is rectified  pairs of corresponding points can be searched for within the same scanlines. we call this search intra-scanline search. this intra-scanline search can be treated as the problem of finding a matching path on a two dimensional  1d  search plane whose axes are the right and left scanlines. vertically connected edges in the images provide consistency constraints across the 1d search planes. inter-scanline search in a three-dimensional  1d  search space  which is a stack of the 1d search planes  is needed to utilize this constraint. 
     our stereo matching algorithm uses edge-delimited intervals as elements to be matched  and employs the above mentioned two searches: one is inter-scanline search for possible correspondences of connected edges in right and left images and the other is intra-scanline search for correspondences of edge-delimited intervals on each scanline pair. dynamic programming is used for both searches which proceed 
simultaneously in two levels: the former supplies the consistency constraints to the latter while the latter supplies the matching score to the former. an interval-based similarity metric is used to compute the score. 
1. introduction 
     stereo is a useful method of obtaining depth information. the key problem in stereo is a search problem which finds the correspondence points between the left and right images  so that  
this research was done while y.ohta was visiting the 
department of computer science  carnegie-mellon university. the research was sponsored in part by the defence advanced research projects agency  dod   arpa order no.1  monitored by the air force avionics laboratory under contract f1-k-1  and in part by the air force office of scientific research under contract f1-c-1. 
takeo kanade 
computer science department 
carnegie-mellon university 
pittsburgh  pa 1 
given the camera model  ie.  the relationship between the right and left cameras of the stereo pair   the depth can be computed by triangulation. in edge-based techniques  edges in the images are used as the elements whose correspondences to be found  1 1 . even though a general problem of finding correspondences between images involves the search within the whole image  the knowledge of the camera model simplifies this image-to-image correspondence problem into a set of scanline-to-scanline correspondence problems. that is  once a pair of stereo images is rectified so that the epipolar lines are horizontal scanlines  a pair of corresponding edges in the right and left images should be searched for only within the same horizontal scanlines. we call this search intra-scanline search. this intra-scanline search can be treated as the problem of finding a matching path on a two-dimensional  1d  search plane whose vertical and horizontal axes are the right and left scanlines. a dynamic programming technique can handle this search efficiently  1 1 . 
     however  if there is an edge extending across scanlines  the correspondences in one scanline have strong dependency on the correspondences in the neighboring scanlines  because if two points are on a vertically connected edge in the left image  their corresponding points should  most likely  lie on a vertically connected edge in the right image. the intra-scanline search alone does not take into account this mutual dependency between scanlines. therefore  another search is necessary which tries to find the consistency among the scanlines  which we call inter-scanline search. 
     by considering both intra- and inter-scanline searches  the correspondence problem in stereo can be cast as that of finding in a three-dimensional  1d  search space an optimal matching surface that most satisfies the intra-scanline matches and inter-scanline consistency. here  a matching surface is defined by stacking 1d matching paths  where the 1d matching paths are found in a 1d search plane whose axes are left-image column position and right-image column position  and the stacking is done in the direction of the row  scanline  number of the images. the cost of the matching surface is defined as the sum of the costs of the intra-scanline matches on the 1d search planes  while vertically connected edges provide the consistency constraints across the 1d search planes and thus penalize those intra-scanline matches which are not consistent across the scanlines. our stereo matching uses dynamic programming for performing both the intra-scanline and the inter-scanline 

y. ohta and t. kanade 1 
searches  and both searches proceed simultaneously in two levels. 

this method reduces the computation to a feasible amount. 
1. use of inter-scanline constraints 
     as mentioned above  for a pair of rectified stereo images  matching edges within the same scanline  ie.  the intra-scanline search  should be sufficient in principle. however  in practice  there is much ambiguity in finding correspondences solely by the intra-scanline search. to resolve the ambiguity  we can exploit the consistency constraints that vertically connected edges across the scanlines provide. suppose a point on a connected edge a in the right image matches with a point on a connected edge v in the left image on scanline t. then  other points on these edges should also match on other scanlines. if edges u and v do not match on scanline t  they should not match on other scanlines  either. we call this property inter-scanline consistency constraint. thus  our problem is to search for a set of matching paths which gives the optimal correspondence of edges within scanlines under the inter-scanline consistency constraint. 
     a few methods have been used to combine the inter-scanline search with the intra-scanline search. henderson  sequentially processed each pair of scanlines and used the result of one scanline to guide the search in the next scanline. however  this method suffers by that the errors made in the earlier scanlines significantly affect the total results. 
     baker  first processed each pair of scanlines independently. after all the intra-scanline matching was done  he used a cooperative process to detect and correct the matching results which violate the consistency constraints. since this method  however  does not use the inter-scanline constraints directly in the search  the result from the cooperative process is not guaranteed to be optimal. baker suggested the necessity of a search which finds an optimal result satisfying the consistency constraints in a 1d search space  but a feasible method was left as an open problem. 
     a straightforward way to achieve a matching which satisfies the inter-scanline constraints is to consider all matchings between connected edges in the right and left images. however  since the typical number of connected edges is a few to several hundred in each image  this brute force method is usually infeasible. 
     we propose to use dynamic programming  which is used for the intra-scanline search  also for the inter-scanline search. these two searches are combined as shown in figure 1. one is for the correspondence of all connected edges in right and left images  and the other is for the correspondence of edges  actually  intervals delimited by edges  on right and left scanlines under the constraint given by the former. the scheme to use dynamic programming in two levels was first employed in the recognition of connected spoken words . they used one search for the possible segmentation at word boundaries and the other for the time-warping word matching under the constraint given by the figure 1. two searches involved in stereo matching. 
former. in connected word recognition  however  the pattern to be processed is a single id vector. in our case  a connected edge crosses over multiple scanlines  ie.  id vectors . this means that we need a 1d search space which is a stack of 1d search planes for intra-scanline matching. 
     dynamic programming  solves an n-stage decision process as n single-stage processes. this reduces the computational complexity to the logarithm of the original combinatorical one. in order to apply dynamic programming  however  the original decision process must satisfy the following two requirements. first  the decision stages must be ordered so that all the stages whose results are needed at a given stage have been processed before them. second  the decision process should be markovian: that is  at any stage the behavior of the process depends solely on the current state and does not depend on the previous history. it is not obvious whether these properties exist in the problem of finding correspondences between connected edges in stereo images  but we clarify them in the following sections. 
1. correspondence search using two-level dynamic programming 
1. intra-scanline search on 1d plane 
     the problem of obtaining a correspondence between edges on the right and left epipolar scanlines can be solved as a path finding problem on a 1d plane. figure 1 illustrates this 1d search plane. the vertical lines show the positions of edges on the left scanline and the horizontal ones show those on the right scanline. we refer to the intersections of those lines as nodes. nodes in this plane correspond to the stages in dynamic programming where a decision should be made to select an optimal path to that node. in the intra-scanline search  the stages must be ordered as follows: when we examine thecorresponden.ee of two edges  one on the right and one on the left scanline  the edges which are on the left of these edges on each scanline must already be processed. for this purpose  we give indices tor edges in left-to-right order on each scanline:  1:m  on the right and  1:n  on the left. both ends of a scanline are also treated as edges for convenience. it is obvious that the condition above is satisfied if we process the nodes with smaller indices first. legal paths which must be 

1 y. ohta and t. kanade 
considered are sequences of straight line segments from node  1  at the upper left corner to node  m n  at the lower right corner on a 1d array  1:m 1:/v . they must go from the upper left to the lower right corners monotonically due to the above-mentioned condition on ordering. this is equivalent to the no-reversal constraints in edge correspondence: that is  the order of matched edges has to be preserved in the right and left scanlines. this constraint excludes from analysis thin objects such as wires and poles which may result in positional reversals in the image. a path has a vertex at node m= m a  when right edge m and left edge n are matched. 
     the cost of a path is defined as follows. let d m k  be the minimal cost of the partial path from node k to node m. d m 1  is the cost of the optimal path to node m from the origin  1 . a primitive path is a partial path which contains no vertices and it is represented by a straight line segment as shown on figure 1. it should be noted that a primitive path actually corresponds to matching the intervals delimited by edges at the start and end nodes rather than edges themselves. the cost of a path is the sum of those of its primitive paths. let d  m k  be the cost of the primitive path from node k to node m.  our actual definition of d m k  will be given in section 1.  obviously  d m k  d m k  and on an optimal path   m k sd m k . 
figure 1. 1d search plane for intra-scanline search. 
intensity profiles are shown along each axis. the horizontal axis corresponds to the left scanline and the vertical one corresponds to the right scanline. vertical and horizontal lines are the edge positions and path selection is done at their intersections. 
vector i represents a primitive path coming to node m. 
when i=1  the primitive path is horizontal  as shown at  a  in figure 1. it corresponds to the case in which a visible part in the left image is occluded in the right image. when y-1  the primitive path is vertical  as shown at  b . when i l and/or j 1  the primitive path skips or ignores beyond i-l and/or y'-l edges on the right and/or left scanlines as shown at  c  in the figure. such a path corresponds to the case where some edges have no corresponding ones on the other scanline because of noise. 
     the path with cost d m 1  gives the optimal correspondence between a pair of scanlines. 
1. inter-scanline starch in 1d space 
¡¡¡¡the problem of obtaining a correspondence between edges under the inter-scanline consistency constraints can be viewed as the problem of finding a set of paths in a 1d space which is a stack of 1d planes for intra-scanline search. figure 1 illustrates this 1d space. the side faces of this space correspond to the right and left images of a stereo pair. the cost of a set of paths is defined as the sum of the costs of the individual paths in the set. we want to obtain an optimal  ie.  the minimal cost  set of paths satisfying the inter-scanline constraints. a pair of connected edges in the right and left images make a set of 1d nodes in the 1d space when they share scanline pairs. we refer 
this may be viewed as a rectangular solid seen from above. the side faces correspond to the right and left stereo images. connected edges in each image form sets of intersections  nodes  in this space. each set is called a 1d node. selection of a set of paths is done at every 1d node. 

to this set of 1d nodes as a single 1d node. the optimal path on a 
1d plane is obtained by iterating the selection of an optimal path at each 1d node. similarly  the optimal set of paths in a 1d space is obtained by iterating the selection of an optimal set of paths at each 1d node. connected edges  1d nodes  and sets of paths between 1d nodes are illustrated in figure 1. 
     as described in section 1  the decision stages must be ordered in dynamic programming. in the intra-scanline search  their ordering was straightforward; it was done by ordering edges from left to right on each scanline. a similar consideration must be given to the inter-scanline search in 1d space where the decision stages are the 1d nodes. a 1d node is actually a set of 1d nodes  and the cost at a 1d node is computed based on the cost obtained by the intra-scanline search on each 1d search plane. this leads to the following condition: when we examine the 
y. ohta and t. kanade 1 
c u  is minimized on the function i t . a 1d node u-i t  gives the start node of the 1d primitive path on scanline t. the inter-scanline constraints is represented by i t . for example  if i t  is independent of i t--l   there are no constraints between scanlines and the search represented by equation  1  becomes equivalent to a set of intra-scanline searches which are performed independently on each scanline. intuitively    t  must be equal to i t-l  in order to keep the consistency constraint. 
the iteration starts at u= 1  and computes c u  for each 
a connected edge u1 is said to be on the left of u1  if all the edges in u1 on the scanlines which u1 and u1 share are on 
the left of those in u1- the  left-of  relationship is transitive; if there is a connected edge u1 and u1 is on the left of u1 and u1 is on the left of u1  then u1 is on the left of u1 the order of two 
connected edges which do not satisfy both the relations described above may be arbitrarily specified. we assign an ordering index 
from left to right for every connected edge in an image. this 
ordering is possible without contradiction when a connected edge never crosses a scanline more than once and when two connected 
edges never intersect each other. our edge-linking process is devised so that it does not make such cases. 1. consistency constraints in int r-scanlin  
     using the term 1d node defined in the previous section  we can describe the inter-scanline consistency constraints as follows: for any 1d node  either all corresponding 1d nodes are the vertices on the set of paths in the 1d search space or none of them are the vertices on the set of paths. we need to represent this constraints as the relation between   t  and i f-l  in equation  1 . to do this  let us consider the example in figure 1. suppose we are trying to obtain a set of 1d primitive paths which reach to node u. in order to satisfy the consistency constraints above  all correspondence of two connected edges  one in the right and one that when there are no connected edges except for the right and in the left image  the connected edges which are on the left of left sides of the images  the algorithm  1  works as a set of these connected edges in each image must already be processed. intra-scanline searches repeated on each scanline independently. in this sense  the 1d algorithm completely contains the 1d one. the starting points of these paths should be the same 1d node; that is i t -i t-l . the cases when the starting point is a different 1d node are shown as case1 and case1 in the figure. in case1  a new 1d node appears at scanline t and the starting point changes to the new one. of course  it is possible that the starting point 
does not change to the new 1d node. this will happen if the cost of the paths having vertices on the 1d node is higher than the cost of the paths not having vertices on it. in case1  the 1d node u-i f-l  disappears on scanline t and the starting point is forced 1d node u in ascending order of u. at each 1d node the i t 's which give the minimum are recorded. the sequence of 1d primitive paths which forms the 1d primitive path is also recorded on each scanline. the set of paths which gives c u  at the 1d node u - c/ l/   which is the 1d node formed by the right ends of stereo images  is obtained as the optimal set. it should be noted 

1 y. ohta and t. kanade 
to move elsewhere. 
     let us denote the 1d node u-i t   from which the 1d primitive path starts and reaches to the 1d node u on scanline t  by frm u;t . then the following rules should be satisfied in each case. 
		 1  
the rules in case1 and case1 require that the decision at 
1d node u depend on decisions at preceding 1d nodes. 
unfortunately  a decision system with such a property is not 
markov urn. as described in section 1  and therefore there is no guarantee of obtaining an optimal solution by using dynamic programming. this means if we search for a solution using dynamic programming with those rules  the result might be poorer than that of the 1d algorithm. 
     in order to assure optimality in dynamic programming  we modify the rules in  1  as follows. 
		 1  
     the new rule for case1 requires the new 1d node on scanline t be on the right of the 1d node that is the starting point on scanline t-1. for case1  the new starting node on scanline t should be on the left of that on scanline t-1. it should be noted that though the new rules are always satisfied when the rules in equation  1  are satisfied  the converse is not true. thus  under the new rules  the consistency constraint might not be satisfied at all places. in other words  the constraints represented by the rules in equation  1  are weaker than those of equation  1 . however  since we can expect to obtain an optimal solution in dynamic programming  we can expect better results by the 1d search algorithm than by the 1d search algorithm. 
1. experiments 
     implementation of the stereo algorithm which has been presented requires a method of detecting edges  linking them into connected edges  and ordering the connected edges. we do not describe  however  the details of the method in this paper because of space limitation and it can be found elsewhere  1j 
     the computation of cost in our search algorithm is based on the cost of a primitive path on the 1d search plane. we define the cost of a 1d primitive path as the similarity between intervals delimited by edges in the right and left images on the same scanline. if we let a1 ... ak and bl ... 1 be the intensity values of the pixels which comprise the two intervals  then the mean and variance of all pixels in the two intervals are computed as: 

     figures 1  1  and 1 show the original stereo pair  edges  and connected edges for the  white house  scene  respectively. the image size is 1 pixels and the intensity resolution is 1 bits. this example is an interesting and difficult one because it includes both buildings and highly textured trees. many connected edges are obtained around the building while few are obtained in the textural part. the disparity maps obtained by the 1d and 1d search algorithms are shown in figure 1. since the maps are registered in the right image coordinates  the disparity values for pixels on the right wall of the central building  which is visible in the right image but occluded in the left  are undetermined. considerable improvements can be observed at the boundaries of buildings. in the textural part  the two algorithms provide approximately the same results. 
     we counted the number of positions where the consistency constraint  described in section 1  is not satisfied. it is 1 in the 1d search and 1 in the 1d search. these numbers quantitatively show a significant improvement achieved by the 1d search algorithm. the reason why the inconsistency is not completely removed in the 1d case is that we used  weaker  rules for the constraint as described earlier. 
1. conclusion 
     in this paper  we have described a stereo algorithm which searches for an optimal solution in a 1d search space using dynamic programming. the algorithm has been applied to urban aerial images successfully. perhaps one of the major reasons that our algorithm works well for such a complex images is as follows. for images which contain long connected edges such as linear structures in urban scenes  our 1d search scheme works effectively to enforce the consistency constraint. when images do not contain long connected edges  our stereo algorithm reduces to 

y. ohta and t. kanade 1 


1 y. ohta and t. kanade 
the ordinary 1d search which works efficiently to match isolated edges within each scanline pair. in other words  when inter-scanline constraints are available  our algorithm fully utilizes them  otherwise it works as the 1d search. this feature will be less obvious in segment-based algorithms  such as in   which depend heavily on the connectivity of edges. 
